<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>reveal.js</title>

  <link rel="stylesheet"
        href="dist/reset.css" />
  <link rel="stylesheet"
        href="dist/reveal.css" />
  <link rel="stylesheet"
        href="dist/theme/blood.css" />

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet"
        href="plugin/highlight/monokai.css" />
</head>

<body>
  <div class="reveal">
    <div class="slides">
      <section>
        <h3>Fleet Dashboards</h3>
        <h4>for Support</h4>
        <h4>Patrick Seidensal &lt;pseidensal@suse.com&gt;</h4>
      </section>

      <section>
        <h3>Table of Contents</h3>

        <ul>
          <li>Installation</li>
          <li>Where to Find the Dashboards?</li>
          <li>Dashboard Organization</li>
          <li>Tour of Dashboards</li>
          <li>Troubleshooting</li>
          <li>Questions</li>
        </ul>
      </section>

      <section>
        <section>
          <h3>Installation</h3>
          <p>
            Just install the <code>rancher-monitoring</code> chart on the <em>local</em> cluster.
          </p>
          <img src="images/monitoring-chart-ui.png" />
          <aside class="notes"></aside>
        </section>
      </section>

      <section>
        <section>
          <h3>Where to Find the Dashboards?</h3>

          Currently, only in Grafana
          <!-- - Grafana is reachable from the Rancher UI. Click on the `local` cluster -> `Monitoring` -> `Grafana` -->
          <img src="images/where-to-find.png" />
        </section>

        <section>
          <h3>Where to Find the Dashboards?</h3>
          <h4>Embedding into Rancher UI <strong>WIP</strong></h4>

          <ul>
            <li>
              <p>Proposal</p>
              <p>
                <a href="https://github.com/rancher/fleet/issues/2634"
                   target="_blank">github.com/rancher/fleet/issues/2634</a>
              </p>
            </li>
            <li>
              <p>Resulting Rancher Dashboard issue</p>
              <p>
                <a href="https://github.com/rancher/dashboard/issues/11571"
                   target="_blank">github.com/rancher/dashboard/issues/11571</a>
              </p>
            </li>
            <li>
              <p>UI/UX issue</p>
              <p>
                <a href="https://jira.suse.com/browse/UXUI-231"
                   target="_blank">jira.suse.com/browse/UXUI-231</a>
              </p>
            </li>
          </ul>
        </section>
      </section>

      <section>
        <section>
          <h3>Dashboard Organization</h3>
        </section>
        <section data-background-image="images/dashboard-org-single-cluster.svg"
                 data-background-size="contain"></section>

        <section data-background-image="images/dashboard-org-two-clusters.svg"
                 data-background-size="contain"></section>

        <section data-background-image="images/dashboard-org-two-paths-with-clustergroup.svg"
                 data-background-size="contain"></section>

        <!-- <section
            data-background-image="images/dashboard-org-from-cluster.svg"
            data-background-size="contain"
          ></section> -->

        <section data-background-image="images/dashboard-org-from-cluster-with-paths.svg"
                 data-background-size="contain"></section>

        <section data-background-image="images/dashboard-org-from-clustergroup-with-paths.svg"
                 data-background-size="contain"></section>
      </section>

      <section>
        <section>
          <h3>Tour of Dashboards</h3>

          <ul>
            <li>GitRepo</li>
            <li>Bundle</li>
            <li>BundleDeployment*</li>
            <li>Cluster</li>
            <li>ClusterGroup</li>
            <li>Controller-Runtime*</li>
          </ul>

          <p>*Not to be embedded in Rancher UI</p>
        </section>

        <section>
          <h3>GitRepo</h3>
          <img src="images/dashboards/gitrepo.png" />
        </section>

        <section>
          <h3>Cluster</h3>
          <img src="images/dashboards/cluster.png" />
        </section>

        <section>
          <h3>ClusterGroup</h3>
          <img src="images/dashboards/clustergroup.png" />
        </section>

        <section>
          <h3>Bundle</h3>
          <img src="images/dashboards/bundle.png" />
        </section>

        <section>
          <h3>BundleDeployment</h3>
          <img src="images/dashboards/bundledeployment.png" />
        </section>

        <section>
          <h3>Controller Runtime</h3>
          <img src="images/dashboards/controller-runtime.png" />
        </section>

        <section>
          <h3>Building Dashboards</h3>
          <p>
            <a href="https://github.com/rancher/fleet-dashboards"
               target="_blank">
              github.com/rancher/fleet-dashboards
            </a>
          </p>
        </section>

      </section>


      <section>
        <section>
          <h3>Troubleshooting</h3>
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>Data Flow</h4>

          <img src="images/data-flow.svg"
               alt="Prometheus Architecture"
               width="35%" />
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>Username and Password</h4>
          <p>admin/prom-operator</p>
          <pre><code>kubectl get secret\
  -n cattle-monitoring-system rancher-monitoring-grafana \
  -o jsonpath='{$.data.admin-password}' |  base64 -d</code></pre>
          <aside class="notes">
            <p>Doesn't work with LDAP, ask your admin</p>
          </aside>
        </section>

        <section>
          <h4>Dashboard X doesn't show data</h4>
          <img src="images/no-data-gitrepo.png" />
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>Dashboard X doesn't show data</h4>
          <hr />
          <ul>
            <li>Just installed?</li>
            <li>Wait for Prometheus to be configured (can take a few minutes!)</li>
            <li>Wait for the data to be scraped (takes a few seconds)</li>
            <li>
              Metrics will only appear if the corresponding resource is created, e.g. GitRepo
            </li>
          </ul>
        </section>

        <section>
          <h3>Troubleshooting</h3>

          <h4>Dashboard X doesn't show data</h4>
          <hr />
          <ul>
            <li>Check the configured time range</li>
          </ul>
          <p>
            <img src="images/time-range.png" />
          </p>
        </section>
        <section>
          <h3>Troubleshooting</h3>

          <h4>Dashboard X doesn't show data</h4>
          <hr />
          <ul>
            <li>Refresh the dashboard</li>
          </ul>
          <p>
            <img src="images/refresh-interval.png" />
          </p>
        </section>
      </section>

      <section>
        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <ul>
            <li>Check the data source in Grafana</li>
            <li>Check the configured scrape targets in Prometheus</li>
            <li>Check the ServiceMonitor resource</li>
            <li>Check the Fleet service</li>
            <li>Check the Fleet controller</li>
          </ul>
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <p>Check the data source in Grafana</p>
        </section>

        <section>
          <video controls
                 src="videos/check-grafana-data-source.webm"
                 height="700"></video>
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <p>Check the configured scrape targets in Prometheus</p>
        </section>

        <section>
          <video controls
                 src="videos/check-prometheus-targets.webm"
                 height="700"></video>
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <p>Check the ServiceMonitor resource</p>
        </section>

        <section>
          <pre><code data-trim data-noescape data-line-numbers="1|3-4">
$ kubectl get smon -n cattle-fleet-system
NAMESPACE                  NAME                                          AGE
cattle-fleet-system        monitoring-fleet-controller                   6d21h
cattle-fleet-system        monitoring-gitops-controller                  6d21h
          </code></pre>
        </section>

        <section>
          <pre><code data-trim data-noescape data-line-numbers="1-2|4|38-40">
$ kubectl get -n cattle-fleet-system \
  smon monitoring-fleet-controller -o yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  annotations:
    meta.helm.sh/release-name: rancher-monitoring
    meta.helm.sh/release-namespace: cattle-monitoring-system
  creationTimestamp: "2024-07-30T11:03:32Z"
  generation: 1
  labels:
    app.kubernetes.io/instance: rancher-monitoring
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: rancher-monitoring
    app.kubernetes.io/version: 104.1.0_up57.0.3
    chart: rancher-monitoring-104.1.0_up57.0.3
    heritage: Helm
    release: rancher-monitoring
  name: monitoring-fleet-controller
  namespace: cattle-fleet-system
  resourceVersion: "7790"
  uid: 8c973d43-43d2-4981-8b38-f0fe5ad53ec6
spec:
  endpoints:
  - metricRelabelings:
    - action: replace
      replacement: local
      sourceLabels:
      - __address__
      targetLabel: cluster_id
    - action: replace
      replacement: local
      sourceLabels:
      - __address__
      targetLabel: cluster_name
    port: metrics
  jobLabel: fleet
  selector:
    matchLabels:
      app: fleet-controller
          </code></pre>
        </section>

        <section>
          <pre><code data-trim data-noescape data-line-numbers="1-2|4|38-40">
kubectl get -n cattle-fleet-system \
  smon monitoring-gitops-controller -o yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  annotations:
    meta.helm.sh/release-name: rancher-monitoring
    meta.helm.sh/release-namespace: cattle-monitoring-system
  creationTimestamp: "2024-07-30T11:03:32Z"
  generation: 1
  labels:
    app.kubernetes.io/instance: rancher-monitoring
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: rancher-monitoring
    app.kubernetes.io/version: 104.1.0_up57.0.3
    chart: rancher-monitoring-104.1.0_up57.0.3
    heritage: Helm
    release: rancher-monitoring
  name: monitoring-gitops-controller
  namespace: cattle-fleet-system
  resourceVersion: "7792"
  uid: 0458e787-42b5-4057-ba1c-b3c49aee9a3f
spec:
  endpoints:
  - metricRelabelings:
    - action: replace
      replacement: local
      sourceLabels:
      - __address__
      targetLabel: cluster_id
    - action: replace
      replacement: local
      sourceLabels:
      - __address__
      targetLabel: cluster_name
    port: metrics
  jobLabel: gitops
  selector:
    matchLabels:
      app: gitjob
          </code></pre>
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <p>Check the Fleet service</p>
        </section>

        <section>
          <pre><code data-trim data-noescape data-line-numbers="1-2|4|25-29|30-32">
kubectl get -n cattle-fleet-system \
  service monitoring-fleet-controller -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    meta.helm.sh/release-name: fleet
    meta.helm.sh/release-namespace: cattle-fleet-system
  creationTimestamp: "2024-07-30T10:59:40Z"
  labels:
    app: fleet-controller
    app.kubernetes.io/managed-by: Helm
  name: monitoring-fleet-controller
  namespace: cattle-fleet-system
  resourceVersion: "5121"
  uid: 612d47dd-06f0-4a7f-99e1-b44aa6124460
spec:
  clusterIP: 10.43.134.194
  clusterIPs:
  - 10.43.134.194
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: metrics
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: fleet-controller
    fleet.cattle.io/shard-default: "true"
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
          </code></pre>
        </section>

        <section>
          <pre><code data-trim data-noescape data-line-numbers="1-2|4|25-29|30-32">
kubectl get -n cattle-fleet-system svc \
  monitoring-gitjob -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    meta.helm.sh/release-name: fleet
    meta.helm.sh/release-namespace: cattle-fleet-system
  creationTimestamp: "2024-07-30T10:59:40Z"
  labels:
    app: gitjob
    app.kubernetes.io/managed-by: Helm
  name: monitoring-gitjob
  namespace: cattle-fleet-system
  resourceVersion: "5113"
  uid: 350503f8-9681-4b36-8a33-63fa5dcf66a6
spec:
  clusterIP: 10.43.58.123
  clusterIPs:
  - 10.43.58.123
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: metrics
    port: 8081
    protocol: TCP
    targetPort: 8081
  selector:
    app: gitjob
    fleet.cattle.io/shard-default: "true"
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
          </code></pre>
        </section>


        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <p>Check the Fleet controller</p>
        </section>

        <section>
          <pre><code data-trim data-noescape data-line-numbers="1|4|5">
kubectl get -n cattle-fleet-system pod
NAME                                READY   STATUS    RESTARTS      AGE
fleet-agent-0                       2/2     Running   0             6d19h
fleet-controller-759bdb8b67-dp4p8   3/3     Running   3 (29h ago)   7d1h
gitjob-7dd55dfd8c-jrgt7             1/1     Running   1 (29h ago)   7d1h
          </code></pre>
        </section>

        <section>
          <h3>Troubleshooting</h3>
          <h4>I don't see <em>any</em> data</h4>
          <hr />
          <p>Disabled Monitoring</p>
          <p>
            <a href="https://github.com/rancher/fleet/blob/main/charts/fleet/values.yaml#L76-L77"
               target="_blank">
              github.com/rancher/fleet/blob/main/charts/fleet/values.yaml#L76-L77
            </a>
          </p>
          <ul>
            <li>No monitoring-.* services</li>
            <li>No exporters listening in Fleet & Gitjob controller</li>
          </ul>
        </section>

      </section>

      <section>
        <h3>Troubleshooting</h3>
        <h4>"Wrong" Data</h4>
        <hr />
        <ul>
          <li>Dashboards reflect data in Fleet resources' status</li>
          <li>Not a Fleet dashboard but rather Fleet issue if Fleet resources show the same values in their status (and
            they are considered wrong)</li>
        </ul>
      </section>

      <section>
        <h3>Troubleshooting</h3>
        <h4>Missing Data</h4>
        <hr />
        <ul>
          <li>Monitoring collects data every X seconds</li>
        </ul>
      </section>

      <section>
        <h3>Outlook</h3>
        <ul>
          <li>More dashboards</li>
          <li>Embedding into Rancher UI</li>
          <li>Alerts</li>
          <li>StackState</li>
        </ul>
      </section>

      <section>
        <h3>Questions?</h3>
      </section>

      <section>
        <h3>Thank you!</h3>
        <p>You can find this presentation on</p>
        <p>
          <a
             href="https://github.com/p-se/fleet-dashboards-for-support">github.com/p-se/fleet-dashboards-for-support</a>
        </p>
      </section>
    </div>
  </div>

  <script src="dist/reveal.js"></script>
  <script src="plugin/notes/notes.js"></script>
  <script src="plugin/markdown/markdown.js"></script>
  <script src="plugin/highlight/highlight.js"></script>

  <!-- https://github.com/zjffun/reveal.js-mermaid-plugin -->
  <script src="https://cdn.jsdelivr.net/npm/reveal.js-mermaid-plugin@2.3.0/plugin/mermaid/mermaid.js"></script>

  <script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
      hash: true,
      progress: true,
      mermaid: {
        theme: "base",
      },

      // Learn about plugins: https://revealjs.com/plugins/
      plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMermaid],
    });
  </script>
</body>

</html>
